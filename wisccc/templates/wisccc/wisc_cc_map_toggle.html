{% load static %}
<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="title" content="cgms-be" />
    <meta name="robots" content="index,follow" />
    <meta name="author" content="Evans Geospatial" />
    <!-- <link rel="stylesheet" href="lib/bootstrap-3.3.6-dist/css/bootstrap.css"> -->
    <!-- debug css version-->
    <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"
        integrity="sha512-wNH6xsp2n8CfB91nrBtfc4sfLwYPBMjSWVUwQOp60AYYXH6i8yCwuKFZ4rgK2i6pQek/b+bSyR7b01/922IBzQ=="
        crossorigin="anonymous"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/css/selectize.default.min.css"
        integrity="sha512-pTaEn+6gF1IeWv3W1+7X7eM60TFu/agjgoHmYhAfLEU8Phuf6JKiiE8YmsNC0aCgQv4192s4Vai8YZ6VNM6vyQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/js/selectize.min.js"
        integrity="sha512-IOebNkvA/HZjMM7MxL0NYeLYEalloZ8ckak+NDtOViP7oiYzG5vn6WVXyrJDiJPhl4yRdmNAG49iuLmhkUdVsQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!-- For qmark icon -->
    <script defer type="text/javascript" src='{% static "js/friconix.js" %}'></script>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
    <script src="{% static 'js/L.Control.Window.js' %}"></script>
    <script type="text/javascript" src='{% static "js/wisccc_legend.js" %}'></script>
    <!-- <link rel="stylesheet" href="css/style.css" type="text/css" /> -->
    <style>
        /* body */
        html,
        body {
            padding: 0;
            margin: 0;
            height: 100%;
        }

        body {
            padding-top: 0px;
            /* the size of the padding-top need to be the one of the navbar */
        }


        /* Main containers */
        .header {
            -webkit-box-shadow: 0 5px 15px rgba(1, 1, 1, .7);
            /* makes a grey shadow below the navbar */
            box-shadow: 0 5px 15px rgba(1, 1, 1, .7);
        }

        .bodyContainer {
            height: 100%;
            width: auto;
            /* need to overwrite the width set by bootstrap */
        }

        .mapContainer {
            height: 100%;
        }

        div#map {
            height: 100%;
            /* to specify the full height for the map, works only if height is set in body and parent divs */
            background-color: #b5d0d0;
            padding-right: 0px;
            /* need to overwrite the padding-right and padding-left set by bootstrap */
            padding-left: 0px;
        }

        div#panel {
            position: absolute;
            top: 50px;
            padding-top: 8px;
            /* needed to move the content below the gray shadow specified in the header */
            height: calc(100% - 50px);
            /* calc is used to substract the height of the navbar */
            width: 400px;
            background-color: #fafafa;
            opacity: 0.92;
            -webkit-transition: width 0.6s;
            transition: width 0.6s;
            z-index: 100;
        }

        /* Collapse buttons */
        div#collapseBtnXs {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 2;
        }

        div#collapseBtnXs button {
            font-weight: bold;
        }

        div#collapseBtn {
            float: right;
            margin-top: 3px;
            margin-right: 3px;
            font-weight: bold;
        }

        div#collapseBtn button {
            font-weight: bold;
        }

        div#panelContent {
            opacity: 1;
            /* better than height: 100% */
            height: inherit;
            /* height: 100%; */
            width: 100%;
            overflow: auto;
            -webkit-transition: opacity 0.6s;
            transition: opacity 0.6s;
        }

        @media all and (max-width: 768px) {
            div#panel {
                width: 0px;
            }

            div#panelContent {
                opacity: 0;
            }
        }

        /* OpenLayers controls */
        .ol-zoom {
            right: 8px;
            top: 12px;
            left: auto;
            /* needed to avoid the background-color of the ol zoom control spanning from the left side of the screen */
        }

        @media all and (max-width: 768px) {
            .ol-zoom {
                top: initial;
                /* needed to clear the top property specified by OpenLayers */
                right: 8px;
                bottom: 6px;
                left: auto;
                /* needed to avoid the background-color of the ol zoom control spanning from the left side of the screen */
            }
        }

        .ol-scale-line {
            right: 40px;
            left: auto;
        }

        /* Hamburger button */
        .header button span {
            background-color: #23527c;
        }

        .navbar-collapse {
            background-color: #fff;
        }

        .navbar {
            margin-bottom: 2px;
        }
    </style>

    <!-- Used for  show/collapse panel functions -->



    <title>Wisconsin Cover Crop Citizen Science Data Network</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />

    <style>
        /*#map{ width: 900px; height: 1000px; }*/
        #map {
            width: 100%;
            height: 100%;
        }

        .legend {
            /*border: 120%;*/
            /*margin: 70px;*/
            padding: 5px;
            text-align: left;
            line-height: 18px;
            color: #000;
            background: #fff;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 1;
        }

        /*    .legend .circle {
      border-radius: 50%;
      width: 10px;
      height: 10px;
      margin-top: 8px;
    }*/
        /* Selectize dropdowns */
        .selectize-dropdown,
        .selectize-input {
            width: 220px !important;
        }
    </style>
    <style>
        /* https://www.w3schools.com/css/tryit.asp?filename=trycss_tooltip_bottom */
        .helptip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted #2f2f2f;
        }

        .bottomtip {
            top: 100%
        }

        .toptip {
            bottom: 100%
        }

        .helptip .helptiptext {
            visibility: hidden;
            width: 200px;
            background-color: #2f2f2f;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            left: 50%;
            margin-left: -80px;

            /* Fade in tooltip - takes 1 second to go from 0% to 100% opac: */
            opacity: 0;
            transition: opacity 1s;
        }

        .helptip:hover .helptiptext {
            visibility: visible;
            opacity: 1;
        }

        .helptip .helptiptext::after {
            content: " ";
            position: absolute;
            bottom: 100%;
            /* At the bottom of the tooltip */
            left: 30%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent#2f2f2f transparent;
        }
    </style>
</head>

<body>

    <!-- navigation bar -->
    <nav class="navbar navbar-lg navbar-light header" role="navigation">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="{% url 'wisc_cc_home' %}">
                Wisconsin Cover Crop Citizen Science Data Network
            </a>
        </div>
        <div class="collapse navbar-collapse" id="navbar">
            <ul class="nav navbar-nav">
                <li><a href="{% url 'wisc_cc_home' %}">Home</a></li>
                <li><a href="{% url 'wisc_cc_graph' %}">Graph</a></li>
                <li><a href="{% url 'wisc_cc_survey' %}">Survey</a></li>
                <li><a href="{% url 'wisc_cc_about' %}">About</a></li>
            </ul>

        </div>
    </nav>

    <div class="container bodyContainer">
        <div class="row mapContainer">

            <!-- panel -->
            <div id="collapseBtnXs" class="visible-xs">
                <button type="button" class="btn" onclick="collapsePanelXs();">+</button>
            </div>

            <div id="panel">

                <div id="collapseBtn">
                    <button type="button" class="btn btn-sm hidden-xs" onclick="collapsePanel();">
                        < </button>
                </div>

                <div id="panelContent" class="container-fluid">
                    <div style="border: black; font-size:12px; width:400px">

                        <h4>Display options</h4>


                        <select id="PropertySelection" class="PropSelector selectize-control single selectize-input">
                            <option value="cc_biomass">Fall Cover crop biomass (tons DM/ac)</option>
                            <option value="cc_species">Cover crop types</option>
                            <option value="acc_gdd">Growing degree units</option>
                            <option value="cc_planting_date_mo">Planting season</option>
                            <option value="previous_crop">Prior crop</option>
                            <option value="fq_rfq">Relative forage quality</option>
                        </select>
                        <div class="helptip"><sup>
                                <img width="20"
                                    src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAACoElEQVR4nO1ZzW4TMRC2UuDAkZ8DEIgdKg5cEQhOvAQBBA9SlEsQgrbXqp1Jo75BKpoDP5feCn0AKngAoAegLWpmSLTlEKPZ8teSKtnY62xRPmmklVaJv88ej8ffKjXCCCO4o27HCvPNGwaprJGfGuB3BvmrBvouET8jvY3fIZUL2LyuKjanho2L0D5vkKcN0LpBtklCI33UwFPjM618cOLjM3TaINc00E5S4v8Igfg/qpdqdCoI+SLyPQO85Uq8S2wWkO+mRvxKzR7VwAspELd7AnhexvJK/kzNHjdAL1Mnj7/T6oWM6YW8zEZI8ubPJl++XLfHnAUESRs8MKpO5E2V7w+RvN1NJ74zEPmzs82TGnhj2AIM8NZAJVbqvMvAj15H9nOrE8fDV5HjfmBIRF5OR5dD6najbf9Gx1pbarQd0oh2irX2hSSzP+0yY09WI7sfj1cdVwF4qj/2FZuTPsVlsFKXFbi11HbcC7QuTWNP/rtdpfvmk7z/9K0TR2XFbfbNr6huX+sjfajsZbAUooj0oLcA4KVhEzUHhEZe7ClALh7ZFUBr/ayAl1Z5P7wIAN7ovQIeLimpCUCK/n8B5tCnEPrZxCmtwFqwMpqOAF4MdpCltAITPQWI6ZRVAQZaV/tt5j5kTYAGet+3myeta+YEIE+qUBca3wI0UpSvts6pJBBHwEveeggNNKuSIr+wfSITl3rkzYF9U/EqMyCgpFwgXuUQU2dOOaNuxwxyIzh55Oc3K/aIN3NXDNdwM8/PvJm7e0zeAJVJA815m/luEK8yjeqkkb84b9hEvikyyAHjTpwiqfNStlVoyOkobccgvZP8RiNPJj5hU0HF5sR0Et9Gena5eMjNTtqRuCWRZ6Q3P99NxF1lFj6zjjCCOvz4ARXq0PBS824rAAAAAElFTkSuQmCC">
                            </sup>
                            <span id="prop_select_helptip" class="helptiptext bottomtip">
                                Use the filters below to show only certain data points.
                                Note that our database is built from about 100 farms, and if you select many filters
                                at once, you may end up with very few or no data points to display.
                            </span>
                        </div>
                        <div id="legend">
                            <svg width="260px" height="180px"></svg>
                            <p>
                                Click on map locations for more info.
                                <br>
                                Actual locations have been<br>obscured to protect landowner's privacy.
                            </p>
                        </div>


                        <h4>Filters</h4>

                        <span>Year
                            <select id="YearFilter" class="YearSelector">
                            </select>
                        </span><br>
                        <span>Soil texture
                            <select id="SoilTextFilter" class="SoilSelector">
                            </select>
                        </span><br>
                        <span>Prior crop
                            <select id="PriorCropFilter" class="PriorCropSelector">
                            </select>
                        </span><br>
                        <span>Tillage type
                            <select id="TillageFilter" class="TillageSelector">
                            </select>
                        </span><br>
                        <span>Seeding method
                            <select id="SeedingFilter" class="SeedingSelector">
                            </select>
                        </span><br>
                        <span>Cover crop species
                            <div class="helptip"><sup>
                                    <img width="20"
                                        src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAACoElEQVR4nO1ZzW4TMRC2UuDAkZ8DEIgdKg5cEQhOvAQBBA9SlEsQgrbXqp1Jo75BKpoDP5feCn0AKngAoAegLWpmSLTlEKPZ8teSKtnY62xRPmmklVaJv88ej8ffKjXCCCO4o27HCvPNGwaprJGfGuB3BvmrBvouET8jvY3fIZUL2LyuKjanho2L0D5vkKcN0LpBtklCI33UwFPjM618cOLjM3TaINc00E5S4v8Igfg/qpdqdCoI+SLyPQO85Uq8S2wWkO+mRvxKzR7VwAspELd7AnhexvJK/kzNHjdAL1Mnj7/T6oWM6YW8zEZI8ubPJl++XLfHnAUESRs8MKpO5E2V7w+RvN1NJ74zEPmzs82TGnhj2AIM8NZAJVbqvMvAj15H9nOrE8fDV5HjfmBIRF5OR5dD6najbf9Gx1pbarQd0oh2irX2hSSzP+0yY09WI7sfj1cdVwF4qj/2FZuTPsVlsFKXFbi11HbcC7QuTWNP/rtdpfvmk7z/9K0TR2XFbfbNr6huX+sjfajsZbAUooj0oLcA4KVhEzUHhEZe7ClALh7ZFUBr/ayAl1Z5P7wIAN7ovQIeLimpCUCK/n8B5tCnEPrZxCmtwFqwMpqOAF4MdpCltAITPQWI6ZRVAQZaV/tt5j5kTYAGet+3myeta+YEIE+qUBca3wI0UpSvts6pJBBHwEveeggNNKuSIr+wfSITl3rkzYF9U/EqMyCgpFwgXuUQU2dOOaNuxwxyIzh55Oc3K/aIN3NXDNdwM8/PvJm7e0zeAJVJA815m/luEK8yjeqkkb84b9hEvikyyAHjTpwiqfNStlVoyOkobccgvZP8RiNPJj5hU0HF5sR0Et9Gena5eMjNTtqRuCWRZ6Q3P99NxF1lFj6zjjCCOvz4ARXq0PBS824rAAAAAElFTkSuQmCC">
                                </sup>
                                <span class="helptiptext toptip">
                                    When you check more than one species, all selected cover crops planted at that time
                                    will show on the graph.
                                    For example if you select 'barley' and 'red clover' then only fields where both
                                    barley and red clover are present are shown.
                                    Cases when barley was planted alone will be filtered out.
                                    Other species may be present but the field will contain both barley and red clover
                                    together.
                                    If no points are displayed on the graph then no participating farmer planted that
                                    combination of cover crops.
                                </span>
                            </div>
                            <select id="SpeciesFilter" class="SpeciesSelector">
                            </select>


                        </span><br>

                        <span>Manure applied prior to cover crop
                            <input type="checkbox" id="PriorManFilter" class="PreManSelector">
                        </span><br>

                        <span>Manure applied post cover crop establishment
                            <input type="checkbox" id="PostManFilter" class="PreManSelector">
                        </span>
                        <br>

                        <span>Filter for points with photos
                            <input type="checkbox" id="HasPhotoFilter" class="HasPhotoFilter">
                        </span>
                        <br>
                        <a href="{% url 'wisc_cc_graph' %}" class="btn btn-primary">Go to graph</a>

                    </div>

                </div>
            </div>


            <!-- map -->
            <div class="col-xs-12" id="map"></div>
        </div>
    </div>


    <script>

        mapLink =
            ' <a href="http://www.esri.com/">Esri</a>';
        wholink =
            'i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community';
        var satelite = L.tileLayer(
            'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; ' + mapLink + ', ' + wholink,
            maxZoom: 18,
        });
        var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        });

        var baseMaps = {
            "Satelite": satelite,
            "Streets, landmarks, etc": osm,

        };

        var max_zoom = 18;
        var map = L.map('map', {
            layers: [osm],
            maxZoom: max_zoom,
            zoomControl: false
        }).setView([44.6373, -90.012], 7);

        $("#map").css("zIndex", 1)




        map.createPane('pane_counties');
        map.getPane('pane_counties').style.zIndex = 300;

        var county_styling = {
            fillColor: "#f0f0f0",
            color: "#252525",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.2
        };

        function cntyPopup(feature, layer) {

            var popupContent = "<dl><dt>" + feature.properties.countyname + " County</dt></dl>";

            if (feature.properties && feature.properties.popupContent) {
                popupContent += feature.properties.popupContent;
            }

            layer.bindPopup(popupContent);
        }
        var wi_counties_json_object;
        var counties_layer = L.layerGroup();

        var cnty_result = $.getJSON("/get_wi_counties", function (data) {
            wi_counties_json_object = L.geoJSON(data, {
                style: county_styling,
                pane: "pane_counties",
                onEachFeature: cntyPopup
            }).addTo(counties_layer);
            map.addLayer(wi_counties_json_object)

        });

        var layerControl = L.control.layers(baseMaps).addTo(map);
        layerControl.addOverlay(counties_layer, "Counties")

        function roundUp(num, precision) {
            precision = Math.pow(10, precision)
            return Math.ceil(num * precision) / precision
        }

        function binRFQ(rfq) {
            if (rfq == null) { return null }

            if (rfq > 151) { return "Prime" }
            if (rfq <= 150 && rfq >= 125) { return "Grade 1" }
            if (rfq < 125 && rfq >= 103) { return "Grade 2" }
            if (rfq < 103 && rfq >= 87) { return "Grade 3" }

        }

        function classifySeason(planting_date) {
            var seasons = {
                // Dec, Jan, Feb
                Winter: [12, 1, 2],
                // March, April, May
                Spring: [3, 4, 5],
                // June, July, August
                Summer: [6, 7, 8],
                // Sept, Oct, Nov
                Fall: [9, 10, 11]
            }
            if (planting_date == null) { return null }
            for (let season in seasons) {
                if (seasons[season].includes(planting_date.getMonth() + 1)) {
                    return season
                }
            }
        };

        function onEachFeature(feature, layer) {
            if (feature.properties.cc_planting_date === null) {
                var planting_date = null;
            } else {
                var planting_date = feature.properties.cc_planting_date.toLocaleDateString();
            }
            var planting_rate = feature.properties.cc_planting_rate;
            if (planting_rate === null | planting_rate == ".") {
                planting_rate = "Not reported";
            }


            var biomass_val = feature.properties.cc_biomass;
            var biomass_val = (biomass_val === null) ? null : roundUp(feature.properties.cc_biomass, 2);
            var spring_biomass_val = feature.properties.spring_cc_biomass;
            var spring_biomass_val = (spring_biomass_val === null) ? null : roundUp(feature.properties.spring_cc_biomass, 2);
            var image_1 = ""
            var image_2 = ""
            if (feature.properties.image_1_url != null) {
                image_1 = "<dt>" + feature.properties.caption_photo_1 + "</dt> <dd>" + '<img src="' + feature.properties.image_1_url + '" width="250" height="250">' + "</dd>"
            }
            if (feature.properties.image_2_url != null) {
                image_2 = "<dt>" + feature.properties.caption_photo_2 + "</dt> <dd>" + '<img src="' + feature.properties.image_2_url + '" width="250" height="250">' + "</dd>"
            }
            var popupContent = "<dl>" +
                "<dt>ID</dt> <dd>" + feature.id + "</dd>" +
                "<dt>Cover crops</dt> <dd>" + feature.properties.cc_species_raw + "</dd>" +
                "<dt>Seeding rate</dt> <dd>" + planting_rate + "</dd>" +
                "<dt>Seeding method</dt> <dd>" + feature.properties.cc_seeding_method + "</dd>" +
                "<dt>Previous crop</dt> <dd>" + feature.properties.previous_crop.toLowerCase().replace("_", " ") + "</dd>" +
                "<dt>Planting date</dt> <dd>" + planting_date + "</dd>" +
                "<dt>Dominant soil texture</dt> <dd>" + feature.properties.dominant_soil_texture + "</dd>" +

                "<dt>Fall Cumulative GDU </dt> <dd>" + feature.properties.acc_gdd + "</dd>" +
                "<dt>Fall Biomass (ton DM/acre)</dt> <dd>" + biomass_val + "</dd>" +

                "<dt>Spring Cumulative GDU </dt> <dd>" + feature.properties.spring_acc_gdd + "</dd>" +
                "<dt>Spring Biomass (ton DM/acre)</dt> <dd>" + spring_biomass_val + "</dd>" +

                image_1 +
                image_2 +
                "</dl>"


            if (feature.properties && feature.properties.popupContent) {
                popupContent += feature.properties.popupContent;
            }
            var popup = L.popup({

                maxHeight: 400
            })
            popup.setContent(popupContent)
            layer.bindPopup(popup);
            // Turning off the hover because it recenters the map automatically
            //  causing some jarring movement. Perhaps this can be salvaged?
            // layer.on('mouseover', function (e) {
            //     this.openPopup(e.latlng);
            // });
            // layer.on('mouseout', function (e) {
            //     this.closePopup();
            // });
        }

        var geojsonMarkerOptions = {
            radius: 8,
            fillColor: "#ff0000",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };

        // var dataurl = '/wisc_cc_static_data';
        var dataurl = '/get_wisc_cc_data';
        var geojsonObject;
        var soilsLayer;

        var soilsCircle = $.getJSON(dataurl, function (data) {

            var dParserYmd = d3.timeParse("%Y-%m-%d")
            getMonthWord = function (dt) {
                let month_word;
                switch (dt.getMonth()) {
                    case 0:
                        month_word = "January";
                        break;
                    case 1:
                        month_word = "February";
                        break;
                    case 2:
                        month_word = "March";
                        break;
                    case 3:
                        month_word = "April";
                        break;
                    case 4:
                        month_word = "May";
                        break;
                    case 5:
                        month_word = "June";
                        break;
                    case 6:
                        month_word = "July";
                        break;
                    case 7:
                        month_word = "August";
                        break;
                    case 8:
                        month_word = "September";
                        break;
                    case 9:
                        month_word = "October";
                        break;
                    case 10:
                        month_word = "November";
                        break;
                    case 11:
                        month_word = "December";
                        break;
                }
                return month_word;
            }
            for (let i = 0; i < data.length; i++) {
                if (data[i].properties.cc_species_raw == null) {
                    data[i].properties.cc_species_raw = ''
                }
                if (data[i].properties.cc_seeding_method == null) {
                    data[i].properties.cc_seeding_method = ''
                }
                if (data[i].properties.dominant_soil_texture == null) {
                    data[i].properties.dominant_soil_texture = ''
                }
                if (data[i].properties.cc_planting_date === null) {
                    data[i].properties.cc_planting_date = null
                } else {
                    data[i].properties.cc_planting_date = dParserYmd(data[i].properties.cc_planting_date.slice(0, 10))
                    data[i].properties.cc_planting_date_mo = getMonthWord(data[i].properties.cc_planting_date)
                }
                data[i].properties.cc_planting_season = classifySeason(data[i].properties.cc_planting_date);
                data[i].properties.rfq_bin = binRFQ(data[i].properties.fq_rfq);
            }
            soilsLayer = data;
            // pop_select_box(soilsLayer, "SpeciesFilter", "cc_species_raw")
            // pop_select_box(soilsLayer, "YearFilter", "year");
            // pop_select_box(soilsLayer, "SeedingFilter", "cc_seeding_method");
            // pop_select_box(soilsLayer, "SoilTextFilter", "dominant_soil_texture");
            // pop_select_box(soilsLayer, "TillageFilter", "residue_remaining");
            var boxes_select = {

                "SpeciesFilter": "cc_species_raw",
                "PriorCropFilter": "previous_crop",
                "SoilTextFilter": "dominant_soil_texture",
                "SeedingFilter": "cc_seeding_method",
                "YearFilter": "year",
                "TillageFilter": "residue_remaining"
            }
            // $('#select_model_type').selectize();
            // $('#xFactor').selectize();
            // $('#select_color').selectize();
            for (k in Object.keys(boxes_select)) {

                id_selector = Object.keys(boxes_select)[k];
                target_field = boxes_select[id_selector]
                $("#" + id_selector).selectize({
                    plugins: ["remove_button"],
                    delimiter: " - ",
                    placeholder: "All",
                    persist: false,
                    closeAfterSelect: true,
                    maxItems: null,
                    valueField: "value",
                    labelField: "label",
                    searchField: ["value", "label"],
                    options: pop_selectize_box(soilsLayer, id_selector, target_field),
                    onChange: function (value, isOnInitialize) {
                        // updateChart(false)
                        filterer()
                        //add the layer to the map again, now that we have changed the filter value. 
                        addLayerToMap();
                    }
                })
            }

            filterer();
            addLayerToMap();
        });

        // for populating select boxes
        var pop_selectize_box = function (geojson_data, id_selector, field_name) {
            var all_instances = [];
            for (item in geojson_data) {

                if (field_name == "cc_species_raw") {
                    var cc_species_raw = geojson_data[item]['properties'][field_name]

                    if (cc_species_raw === null) { continue; }

                    all_instances = all_instances.concat(cc_species_raw.split(", "));


                } else {
                    all_instances.push(geojson_data[item]['properties'][field_name])
                }

            }
            // Deduplicating
            const uniq_instances = [...new Set(all_instances)];
            uniq_instances.sort()
            var filt = document.getElementById(id_selector);
            var option_array = []
            uniq_instances.forEach(function (item) {
                option_array.push({ label: item, value: item })

            })
            return option_array;
        }
        var pop_select_box = function (geojson_data, id_selector, field_name) {
            var all_instances = [];
            for (item in geojson_data) {
                if (field_name == "cc_species_raw") {
                    var cc_species_raw = geojson_data[item]['properties'][field_name]

                    if (cc_species_raw === null) { continue; }

                    all_instances = all_instances.concat(cc_species_raw.split(", "));


                } else {
                    all_instances.push(geojson_data[item]['properties'][field_name])
                }


            }
            const uniq_instances = [...new Set(all_instances)];
            console.log(uniq_instances)
            var filt = document.getElementById(id_selector);
            var newOption = document.createElement("option");
            newOption.text = "All";
            newOption.value = "All";
            filt.add(newOption);
            uniq_instances.forEach(function (item) {
                // console.log(item)
                if (item === null) { return }
                var newOption = document.createElement("option");
                newOption.text = item.toString();
                newOption.value = item.toString();
                filt.add(newOption);
            })
        }

        let filter_values;

        var filterer = function (feature) {
            filter_values = {
                year: false,
                cc_species_raw: false,
                manure_prior: false,
                manure_post: false,
                has_photo: false
            }



            filter_values['year'] = $("#YearFilter").selectize()[0].selectize.getValue().map((x) => parseInt(x))

            filter_values['cc_seeding_method'] = $("#SeedingFilter").selectize()[0].selectize.getValue();
            filter_values['dominant_soil_texture'] = $("#SoilTextFilter").selectize()[0].selectize.getValue();
            filter_values['previous_crop'] = $("#PriorCropFilter").selectize()[0].selectize.getValue();
            filter_values['cc_species_raw'] = $("#SpeciesFilter").selectize()[0].selectize.getValue();
            filter_values['residue_remaining'] = $("#TillageFilter").selectize()[0].selectize.getValue();
            filter_values['manure_prior'] = prior_manure;
            filter_values['manure_post'] = post_manure;

            filter_values['has_photo'] = has_photo;


        }

        // For use in the filter function in addLayerToMap
        // Will be run on an individual feature
        // filterArray is the array of selected cover crop 
        // species from speciesFilter
        // plantedArray is the array created from splitting the comma
        //  separated list of planted cover crops from the submitted surveys.
        const isTrue = (currentValue) => currentValue == true;
        var containsTargetSpecies = function (filterArray, plantedArray) {
            // an array as long as the filter array, with a true or false for if
            //  the requested item in the filter is planted
            var isPresent = [];
            for (i in filterArray) {
                if (plantedArray.includes(filterArray[i])) {
                    isPresent.push(true);
                } else {
                    isPresent.push(false);
                }
            }
            return isPresent.every(isTrue);
        }
        var containsTargetSpeciesOr = function (filterArray, plantedArray) {
            // Currently if *any* species in the filter is found planted then true is returned.k
            // Thus the filter logic is *or* (is either 'kale' or 'flax' planted? True.)
            for (i in plantedArray) {
                if (filterArray.includes(plantedArray[i])) {
                    return true;
                }
            } return false;
        }


        // var $select = $('#SpeciesFilter').selectize({valueField: "value", labelField: "label", options: pop_selectize_box(soilsLayer, "#SpeciesFilter", "cc_species_raw")})


        function addLayerToMap() {
            //remove the layer from the map entirely
            if (map.hasLayer(geojsonObject)) {
                geojsonObject.remove();
            }
            //add the data layer and style based on attribute. 

            geojsonObject = L.geoJson(soilsLayer, {

                filter: (feature) => {

                    // Filter each property by the selected filter value
                    // If no filter, then length of array is 0, then the filter value is true, hence the or statement
                    // BROKEN: currently this is will hit true only if *all* items in the filter array are present in the record
                    // currently only affect cc_species_raw.
                    // solution: special function to check if *any* of the contained species are present in the filter
                    const filt_year = (filter_values.year.length == 0) ? true : (filter_values.year.includes(feature.properties.year));
                    const filt_seeding = (filter_values.cc_seeding_method.length == 0) ? true : (filter_values.cc_seeding_method.includes(feature.properties.cc_seeding_method));
                    const filt_soiltext = (filter_values.dominant_soil_texture.length == 0) ? true : (filter_values.dominant_soil_texture.includes(feature.properties.dominant_soil_texture));
                    const filt_priorcrop = (filter_values.previous_crop.length == 0) ? true : (filter_values.previous_crop.includes(feature.properties.previous_crop));
                    //const filt_species = (filter_values.cc_species_raw.length == 0) ? true : (filter_values.cc_species_raw.includes(feature.properties.cc_species_raw));
                    const filt_species = (filter_values.cc_species_raw.length == 0) ? true : (containsTargetSpecies(filter_values.cc_species_raw, feature.properties.cc_species_raw.split(", ")));

                    const filt_till = (filter_values.residue_remaining.length == 0) ? true : (filter_values.residue_remaining.includes(feature.properties.residue_remaining));
                    const filt_priorman = (filter_values.manure_prior == false) ? true : (feature.properties.manure_prior == "Yes");
                    const filt_postman = (filter_values.manure_post == false) ? true : (feature.properties.manure_post == "Yes");

                    const filt_hasphoto = (filter_values.has_photo == false) ? true : (feature.properties.image_1_url != null);

                    return filt_year && filt_seeding && filt_soiltext && filt_species && filt_till && filt_priorman && filt_postman && filt_priorcrop && filt_hasphoto//only true if both are true
                },

                pointToLayer: function (feature, latlng) {
                    return new L.CircleMarker(latlng, geojsonMarkerOptions);
                },
                onEachFeature: onEachFeature,
                style: function (feature) {
                    updateLegend(biomassScale, ".1f");
                    return {
                        fillColor: biomassScale(feature.properties.cc_biomass)
                    };
                },
            }).addTo(map);
            var selected_property = $('#PropertySelection').val();
            updateStyle(selected_property);
            updateHelpTipText(selected_property);
            console.log(Object.keys(geojsonObject._layers).length + " locations after filtering.")
        }

        $("#YearFilter").on("input", function () {
            filterer()
            //add the layer to the map again, now that we have changed the filter value. 
            addLayerToMap();
        });
        $("#SeedingFilter").on("input", function () {
            filterer()
            //add the layer to the map again, now that we have changed the filter value. 
            addLayerToMap();
        });
        $("#SoilTextFilter").on("input", function () {
            filterer()
            //add the layer to the map again, now that we have changed the filter value. 
            addLayerToMap();
        });
        $("#PriorCropFilter").on("input", function () {
            filterer()
            //add the layer to the map again, now that we have changed the filter value. 
            addLayerToMap();
        });
        $("#SpeciesFilter").on("input", function () {
            filterer()
            //add the layer to the map again, now that we have changed the filter value. 
            addLayerToMap();
        });
        $("#TillageFilter").on("input", function () {
            filterer()
            //add the layer to the map again, now that we have changed the filter value. 
            addLayerToMap();
        });
        let prior_manure = document.getElementById('PriorManFilter').checked;
        $("#PriorManFilter").on("input", function () {

            prior_manure = document.getElementById('PriorManFilter').checked

            filterer()
            //add the layer to the map again, now that we have changed the filter value. 
            addLayerToMap();
        });
        let post_manure = document.getElementById('PostManFilter').checked;
        $("#PostManFilter").on("input", function () {

            post_manure = document.getElementById('PostManFilter').checked

            filterer()
            //add the layer to the map again, now that we have changed the filter value. 
            addLayerToMap();
        });
        let has_photo = document.getElementById('HasPhotoFilter').checked;
        $("#HasPhotoFilter").on("input", function () {

            has_photo = document.getElementById('HasPhotoFilter').checked

            filterer()
            //add the layer to the map again, now that we have changed the filter value. 
            addLayerToMap();
        });




        function updateHelpTipText(property) {
            console.log("updateHelpTipText firing!. Property: " + property)
            var text = ""
            if (property == "acc_gdd") {
                text = "Cumulative growing degree units measure the amount of growth-producing warmth a crop plant receives by a certain date."
            }
            if (property == "cc_biomass") {
                text = "Biomass is the weight of aboveground plant material at time of collection, and ton DM/acre = tons of dry matter of biomass per acre (please note this is tons not pounds!)"
            }
            if (property == "fq_rfq") {
                text = "Relative forage quality is a measure of how good the harvested cover crop was for use as forage for livestock."
                text += 'The grades are based on a scale from <a href="https://cropsandsoils.extension.wisc.edu/hay-market-demand-and-price-report-for-the-upper-midwest-for-october-10-2023/">UW Extension</a>.'
                text += "<br>   Prime (> 151 RFV/RFQ)<br>"
                text += "Grade 1 (125 to 150 RFV/RFQ)<br>"
                text += "Grade 2 (103 to 124 RFV/RFQ)<br>"
                text += "Grade 3 (87 to 102 RFV/RFQ)"
            }
            if (property == "cc_species") {
                text = "The cover crop type is a classification derived from the mix of cover crops planted and is based on the plant families."
            }
            if (property == "previous_crop") {
                text = "The crop preceding the cover crop."
            }
            if (property == "cc_planting_date_mo") {
                text = "The season the cover crop was planted."
                text += "Winter is considered December, January, and February. <br> "
                text += "Spring is considered March, April, and May. <br>"
                text += "Summer is considered June, July, and August. <br> "
                text += "Fall is considered September, October, and November."
            }
            $("#prop_select_helptip").html(text);
        }

        function updateStyle(property) {
            geojsonObject.eachLayer(function (layer) {
                removeLegend(".nullLegend");
                if (property == "acc_gdd") {
                    layer.setStyle({
                        fillColor: layer.feature.properties.acc_gdd ? gddScale(layer.feature.properties.acc_gdd) : "#ccc"
                    })
                    updateLegend(gddScale, ".0f")


                    createNullLgend("translate(20, 147)")
                } else if (property == "cc_biomass") {
                    layer.setStyle({
                        fillColor: layer.feature.properties.cc_biomass ? biomassScale(layer.feature.properties.cc_biomass) : "#ccc"
                    })
                    updateLegend(biomassScale, ".1f")

                    createNullLgend("translate(20, 147)")
                } else if (property == "fq_rfq") {
                    layer.setStyle({
                        fillColor: layer.feature.properties.rfq_bin ? rfqBinsScale(layer.feature.properties.rfq_bin) : "#ccc"
                    })
                    updateLegend(rfqBinsScale, "c")
                    // layer.setStyle({
                    //     fillColor: layer.feature.properties.fq_rfq ? rfqScale(layer.feature.properties.fq_rfq) : "#ccc"
                    // })
                    // updateLegend(rfqScale, ".0f")
                } else if (property == "cc_species") {
                    layer.setStyle({
                        fillColor: layer.feature.properties.cc_species ? speciesScale(layer.feature.properties.cc_species) : "#ccc"
                    })
                    updateLegend(speciesScale, "c")
                } else if (property == "cc_planting_date_mo") {

                    layer.setStyle({
                        fillColor: layer.feature.properties.cc_planting_season ? plantingSeasonScale(layer.feature.properties.cc_planting_season) : "#ccc"
                    })
                    updateLegend(plantingSeasonScale, "c")

                    // layer.setStyle({
                    //     fillColor: layer.feature.properties.cc_planting_date_mo ? plantingScale(layer.feature.properties.cc_planting_date_mo) : "#ccc"
                    // })
                    // updateLegend(plantingScale, "c")
                } else if (property == "previous_crop") {

                    layer.setStyle({
                        fillColor: layer.feature.properties.previous_crop ? colorScalePriorCrops(layer.feature.properties.previous_crop) : "#ccc"
                    })
                    updateLegend(colorScalePriorCrops, "c")

                    // layer.setStyle({
                    //     fillColor: layer.feature.properties.cc_planting_date_mo ? plantingScale(layer.feature.properties.cc_planting_date_mo) : "#ccc"
                    // })
                    // updateLegend(plantingScale, "c")

                }


            })
        }




        //Maybe this: https://github.com/timwis/leaflet-choropleth

        // Call updateScale when everything is loaded. Seemed to be an issue where
        //  the on change would try to be attached before the leaflet control containing 
        //  the dropdown and slider were located was created
        $('body').on('change', '#PropertySelection', function () {
            var selected_property = $('#PropertySelection').val();
            updateStyle(selected_property);

            updateHelpTipText(selected_property);
        });

        new L.Control.Zoom({ position: 'bottomright' }).addTo(map);
        $('body').on('change', '#ZoomSelection', function () {
            var selected_zoom = $('#ZoomSelection').val();
            map.setMaxZoom(parseInt(selected_zoom))
        });


    </script>


    <script type="text/javascript">
        var showPanel = true;
        var collapsePanel = function () {
            if (showPanel === true) {
                $('div#panel').css('width', '35px');
                $('div#panelContent').css('opacity', '0');
                $('div#collapseBtn button').text('>');
                showPanel = !showPanel;
            }
            else {
                $('div#panel').css('width', '300px');
                $('div#panelContent').css('opacity', '1');
                $('div#collapseBtn button').text('<');
                showPanel = !showPanel;
            }
        }
        // Hide/show panel function for mobile view. The panel is not shown by default.
        var showPanelXs = false;
        var collapsePanelXs = function () {
            if (showPanelXs === true) {
                $('div#panel').css('width', '0px');
                $('div#panelContent').css('opacity', '0');
                showPanelXs = !showPanelXs;
            }
            else {
                $('div#panel').css('width', 'calc(100% - 45px)');
                $('div#panelContent').css('opacity', '1');
                $('div#navbar').removeClass('in')
                showPanelXs = !showPanelXs;
            }
        }
    </script>




</body>

</html>

<!-- <script type="text/javascript" src="map.js"></script> -->