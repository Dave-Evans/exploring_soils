{% load static %}
<!DOCTYPE html>

<html>

<head>

    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


    <meta name="author" content="Evans Geospatial" />

    <meta name="date" content="2022-09-01" />

    <title>Wisconsin Citizen Science Cover Crop Project</title>
    <!-- Deleted Script -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Delete stylesheet -->
    <!-- Delete script -->
    <!-- Deleted script -->
    <!-- Delete stylesheet -->
    <!-- Deleted script -->


    <style type="text/css">
        code {
            white-space: pre;
        }
    </style>
    <style type="text/css">
        pre:not([class]) {
            background-color: white;
        }
    </style>
    <script type="text/javascript">
        if (window.hljs) {
            hljs.configure({ languages: [] });
            hljs.initHighlightingOnLoad();
            if (document.readyState && document.readyState === "complete") {
                window.setTimeout(function () { hljs.initHighlighting(); }, 0);
            }
        }
    </script>



    <style type="text/css">
        h1 {
            font-size: 34px;
        }

        h1.title {
            font-size: 38px;
        }

        h2 {
            font-size: 30px;
        }

        h3 {
            font-size: 24px;
        }

        h4 {
            font-size: 18px;
        }

        h5 {
            font-size: 16px;
        }

        h6 {
            font-size: 12px;
        }

        .table th:not([align]) {
            text-align: left;
        }
    </style>




    <style type="text/css">
        .main-container {
            max-width: 940px;
            margin-left: auto;
            margin-right: auto;
        }

        code {
            color: inherit;
            background-color: rgba(0, 0, 0, 0.04);
        }

        img {
            max-width: 100%;
        }

        .tabbed-pane {
            padding-top: 12px;
        }

        .html-widget {
            margin-bottom: 20px;
        }

        button.code-folding-btn:focus {
            outline: none;
        }

        summary {
            display: list-item;
        }
    </style>



    <!-- tabsets -->

    <style type="text/css">
        .navbar-fixed-top {
            background: white;
        }

        .tabset-dropdown>.nav-tabs {
            display: inline-table;
            max-height: 500px;
            min-height: 44px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .tabset-dropdown>.nav-tabs>li.active:before {
            content: "";
            font-family: 'Glyphicons Halflings';
            display: inline-block;
            padding: 10px;
            border-right: 1px solid #ddd;
        }

        .tabset-dropdown>.nav-tabs.nav-tabs-open>li.active:before {
            content: "";
            border: none;
        }

        .tabset-dropdown>.nav-tabs.nav-tabs-open:before {
            content: "";
            font-family: 'Glyphicons Halflings';
            display: inline-block;
            padding: 10px;
            border-right: 1px solid #ddd;
        }

        .tabset-dropdown>.nav-tabs>li.active {
            display: block;
        }

        .tabset-dropdown>.nav-tabs>li>a,
        .tabset-dropdown>.nav-tabs>li>a:focus,
        .tabset-dropdown>.nav-tabs>li>a:hover {
            border: none;
            display: inline-block;
            border-radius: 4px;
            background-color: transparent;
        }

        .tabset-dropdown>.nav-tabs.nav-tabs-open>li {
            display: block;
            float: none;
        }

        .tabset-dropdown>.nav-tabs>li {
            display: none;
        }

        div.tooltip {
            position: absolute;
            text-align: left;
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }

        /* Main containers */
        .header {
            -webkit-box-shadow: 0 5px 15px rgba(1, 1, 1, .7);
            /* makes a grey shadow below the navbar */
            box-shadow: 0 5px 15px rgba(1, 1, 1, .7);
        }

        th,
        td {
            border: 7px solid white;

        }
    </style>

    <!-- code folding -->



    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
</head>

<body>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script type="text/javascript" src='{% static "js/wisccc_legend.js" %}'></script>
    <script type="text/javascript"
        src='https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js'></script>
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/css/selectize.default.min.css"
        integrity="sha512-pTaEn+6gF1IeWv3W1+7X7eM60TFu/agjgoHmYhAfLEU8Phuf6JKiiE8YmsNC0aCgQv4192s4Vai8YZ6VNM6vyQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/js/selectize.min.js"
        integrity="sha512-IOebNkvA/HZjMM7MxL0NYeLYEalloZ8ckak+NDtOViP7oiYzG5vn6WVXyrJDiJPhl4yRdmNAG49iuLmhkUdVsQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <nav class="navbar navbar-fixed-top header" role="navigation">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="{% url 'wisc_cc_home' %}">Wisconsin Citizen Science Cover Crop Project</a>
        </div>
        <div class="collapse navbar-collapse" id="navbar">
            <ul class="nav navbar-nav">
                <li><a href="{% url 'wisc_cc_home' %}">Home</a></li>
                <li><a href="{% url 'wisc_cc_map' %}">Map</a></li>
                <li><a href="{% url 'wisc_cc_survey' %}">Survey</a></li>
            </ul>
        </div>
    </nav>
    <br />
    <br />
    <div class="container-fluid main-container">

        <div class="fluid-row" id="header">

            <h2 class="title toc-ignore"><br>Wisconsin Citizen Science Cover Crop Project</h2>


            <button type="button" style="border: 1px solid;" class="btn btn-secondary btn-lg" data-toggle="modal"
                data-target="#helpInformation">
                How to use this graph
            </button>
        </div>
        <br>
        <!-- <iframe id="iframe_wisc_cc_map" title="map of participating farmers" width=300 height=400
            src="http://dev.evansgeospatial.com/wisc_cc_map_embed"></iframe> -->
        <div id=" data-collection" class="section level2">

            <div class="figure" style="text-align: center">


                <div class="row">
                    <div class="col-md-2" id="legend">
                        <br>
                        <div style="text-align: left;">
                            <label style="font-size: medium;">Color</label>
                        </div>
                        <select id="select_color" class="group-select">
                            <option value="cc_species" selected>Cover crop species</option>
                            <option value="region">NOAA Climate Regions</option>
                            <option value="previous_crop">Cash crop prior</option>
                        </select>

                        <svg width="200px" height="250px"></svg>
                        <br>

                    </div>
                    <div class="col-md-8" id="my_dataviz">
                    </div>
                </div>

                <div class="row" style="text-align: left;">
                    <div class=" col-md-6"><label style="font-size: medium;">Filters</label></div>
                    <div class=" col-md-4"><label style="font-size: medium;">X axis</label></div>
                </div>
                <div class="row" style="text-align: left;">
                    <div class=" col-md-6" id="filters">
                        <table>
                            <tr>
                                <td>Cover crop species</td>
                                <td><select id="select_species" class="group-select">
                                    </select></td>
                            </tr>
                            <!-- <tr>
                                <td>County Selectize</td>
                                <td><select id="selectize_county" multiple placeholder="Select counties...">
                                    </select></td>
                            </tr> -->
                            <tr>
                                <td>County</td>
                                <td><select id="select_county" class="group-select">
                                    </select></td>
                            </tr>
                            <tr>
                                <td>Planting Year</td>
                                <td><select id="select_planting_year" class="group-select">
                                    </select></td>
                            </tr>
                            <tr>
                                <td>Soil Texture</td>
                                <td><select id="select_soil_texture" class="group-select">
                                    </select></td>
                            </tr>
                            <tr>
                                <td>Tillage</td>
                                <td><select id="select_tillage" class="group-select">
                                    </select></td>
                            </tr>
                            <tr>
                                <td>Seeding Method</td>
                                <td><select id="select_seeding_method" class="group-select">
                                    </select></td>
                            </tr>
                            <tr>
                                <td>Manure applied prior to cover crop</td>
                                <td><input type="checkbox" id="checkbox_manure_prior" class="group-select"></td>
                            </tr>
                            <tr>
                                <td>Manure applied post cover crop establishment</td>
                                <td><input type="checkbox" id="checkbox_manure_post" class="group-select"></td>

                            </tr>

                        </table>

                    </div>
                    <!-- <div class="col-md-4" id="color_changer">
                        <select id="select_color" class="group-select">
                            <option value="region" selected>Region</option>
                            <option value="cc_species">Cover crop species</option>
                            <option value="previous_crop">Cash crop prior</option>
                        </select> <br>
                    </div> -->
                    <div class="col-md-4" id="x_axis_changer">

                        <select id="xFactor" class="group-select">
                            <option value="total_precip" selected>Total precipitation</option>
                            <option value="acc_gdd">Growing degree units</option>
                            <option value="cc_planting_date_flat">Planting date</option>

                        </select>

                    </div>

                    <div class="col-md-4" id="lin_reg">


                        <table>
                            <br>
                            <label style="font-size: medium;">Regression line</label>
                            <tr>
                                <td>Add regression line</td>
                                <td><input type="checkbox" id="checkbox_linreg_line" class="group-select"></td>
                            </tr>
                            <tr>
                                <td>
                                    <div>
                                        <select id="select_model_type" class="group-select">
                                            <option value="linear" selected>Linear</option>
                                            <option value="quadratic">Quadratic</option>
                                        </select>
                                    </div>
                                </td>
                                <td>

                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div> <span id="regression_explanation"></span></div>
                                </td>
                                <td>

                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div><span id="regression_equation"></span></div>
                                </td>
                            </tr>

                        </table>



                    </div>
                </div>
                <br>


            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="helpInformation" tabindex="-1" role="dialog" aria-labelledby="helpInformationLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="exampleModalLabel">About this graph
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </h3>
                </div>
                <div class="modal-body">
                    <p>This graph shares farmer data about how cover crops grow in Wisconsin. Each colored data point
                        represents cover crop information for one field from a farmer who completed a survey in fall
                        2020, 2021, or 2022.
                    </p>
                    <p>The graph illustrates the relationship between cover crop biomass (how much
                        of the cover crop was present above ground) and different factors which could influence how well
                        it grew.
                    </p>
                    <p><label style="font-size: medium;">X-Axis:</label> Here, can choose to visualize the relationship
                        between biomass and total
                        precipitation,
                        growing degree units*, or planting date.
                    </p>
                    <p><label style="font-size: medium;">Change color:</label> You can use the colors to explore data by
                        climate region**, cover crop
                        species, or
                        crop planted prior to cover crop.</p>
                    <p><label style="font-size: medium;">Filters:</label> Explore the relationship between cover crop
                        biomass and factors such as county, tillage, cover crop species and more.
                        (Note that our database is built on input from about 100 farms, and if you select many filters
                        at once, you may end up with very few data points to display or the
                        graph may be empty.)</p>
                    <p><label style="font-size: medium;">Regression line:</label> Toggle to visualize the statistical
                        relationship between cover crop
                        biomass and
                        the
                        selected growth variable. When checked, you will see a regression line, an equation representing
                        the
                        statistical relationship of the variables, and a brief sentence describing how much variation is
                        explained by the select growth factor.</p>

                    <p><label style="font-size: medium;">Hover</label> over colored points for details from individual
                        farmers where we have them,
                        including
                        planting
                        rate and manure application if used.</p>
                    <hr>
                    <p><label style="font-size: medium;">*Growing degree units</label> are a measure of how much heat
                        has
                        accumulated over a season. This can
                        indicate
                        how favorable were conditions for plants.
                    <p><label style="font-size: medium;">**Climate regions</label> are areas delineated by the <a
                            target="_blank" rel="noopener noreferrer"
                            href="https://www.ncei.noaa.gov/access/monitoring/reference-maps/conus-climate-divisions">National
                            Oceanic and Atmospheric Administration
                            (NOAA)</a> to create areas of similar temperature and precipitation.
                    </p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script>

        var margin = { top: 10, right: 30, bottom: 55, left: 50 },
            width = 700 - margin.left - margin.right,
            height = 450 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#my_dataviz")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");






        var seeding2symbol = {
            "DRILL": d3.symbol().type(d3.symbolSquare)(),
            "BROADCAST": d3.symbol().type(d3.symbolTriangle)(),
            "BROADCAST_INCORPORATION": d3.symbol().type(d3.symbolCross)(),
            "AERIAL": d3.symbol().type(d3.symbolStar)(),
            "MANURE_SLURRY": d3.symbol().type(d3.symbolDiamond)(),
            "OTHER": d3.symbol().type(d3.symbolCircle)()
        }

        var listSeedingMethods = [
            "DRILL",
            "BROADCAST",
            "BROADCAST_INCORPORATION",
            "AERIAL",
            "MANURE_SLURRY",
            "OTHER"
        ]

        var seedingMethodsMap = listSeedingMethods.map(function (f) {
            return f in seeding2symbol ? seeding2symbol[f] : d3.symbol().type(d3.symbolWye)
        })

        var seedingSymbolScale = d3.scaleOrdinal()
            .domain(listSeedingMethods)
            .range(seedingMethodsMap);

        function formatToolTip(feature) {

            var tool_tip_string =
                //"Total precip: " + feature.properties.total_precip + " in" + "<br/>" +
                feature.properties.county_single + " County" + "<br/>" +
                feature.properties.cc_species + "<br/>" +
                feature.properties.cc_planting_rate + "<br/>"

            if (feature.properties.manure_value | feature.properties.manure_value > 0) {
                tool_tip_string += "Manure applied: " +
                    feature.properties.manure_value + " " +
                    feature.properties.manure_rate
            } else {
                tool_tip_string += "No manure applied"
            }

            return tool_tip_string;


        }
        var dataurl = '/wisc_cc_static_data';
        var submission_data;

        var model_data = [];

        d3.json(dataurl, function (data) {
            submission_data = data;
            // For tooltip
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            var min_year = d3.min(submission_data.map(function (child) {
                return child.properties["year"]
            }))
            // Converting dates to times
            var dParserYmd = d3.timeParse("%Y-%m-%d")
            for (let i = 0; i < data.length; i++) {

                // Coding counties to regions
                data[i].properties.region = getRegion(data[i].properties.county_single)
                if (data[i].properties.region == "Other") {

                    console.log("Other for " + i + " " + data[i].id)
                    console.log(data[i].properties.county_single)
                }
                // Formatting for pretty display
                data[i].properties.previous_crop = data[i].properties.previous_crop[0] + data[i].properties.previous_crop.substring(1).toLowerCase().replace("_", " ")

                // Converting planting dates to be all same year for 
                //   overlapping display
                if (data[i].properties.cc_planting_date === null) {
                    data[i].properties.cc_planting_date_flat = null;
                    continue;
                }
                // Convert these to dates

                data[i].properties.cc_planting_date = dParserYmd(data[i].properties.cc_planting_date.slice(0, 10))
                var cov_crop_planting_date = new Date();
                cov_crop_planting_date.setFullYear(data[i].properties.cc_planting_date.getFullYear())
                cov_crop_planting_date.setMonth(data[i].properties.cc_planting_date.getMonth())
                cov_crop_planting_date.setDate(data[i].properties.cc_planting_date.getDate())

                console.log("Planting date: " + data[i].properties.cc_planting_date)


                //Julian day calc
                data[i].properties.julian_day = calcJulianDay(data[i].properties.cc_planting_date)

                if (cov_crop_planting_date.getFullYear() == min_year) {
                    data[i].properties.cc_planting_date_flat = data[i].properties.cc_planting_date;
                    continue;
                }
                var year_diff = cov_crop_planting_date.getFullYear() - min_year;
                cov_crop_planting_date.setFullYear(cov_crop_planting_date.getFullYear() - year_diff);


                data[i].properties.cc_planting_date_flat = cov_crop_planting_date

            }
            // Hack to limit the graphs to just 2020 and 2021 (years flattened so just need  == 2020)
            // data = data.filter(function (d) { return d.properties.cc_planting_date_flat.getFullYear() == 2020 })
            submission_data = data;
            var pop_selectize_box = function (geojson_data, id_selector, field_name) {
                var all_instances = [];
                for (item in geojson_data) {

                    all_instances.push(geojson_data[item]['properties'][field_name])

                }
                // Deduplicating
                const uniq_instances = [...new Set(all_instances)];
                uniq_instances.sort()
                var filt = document.getElementById(id_selector);
                var option_array = []
                uniq_instances.forEach(function (item) {
                    option_array.push({ label: item, value: item })
                    // controller.addOption({
                    //     label: item.toString(),
                    //     value: item.toString()
                    // });
                })
                return option_array;
            }


            var pop_select_box = function (geojson_data, id_selector, field_name) {
                var all_instances = [];
                for (item in geojson_data) {

                    all_instances.push(geojson_data[item]['properties'][field_name])

                }
                // Deduplicating
                const uniq_instances = [...new Set(all_instances)];
                uniq_instances.sort()
                var filt = document.getElementById(id_selector);

                var newOption = document.createElement("option");
                newOption.text = "All";
                newOption.value = "All";
                filt.add(newOption);

                uniq_instances.forEach(function (item) {
                    // console.log(item)
                    if (item === null) { return }
                    var newOption = document.createElement("option");
                    newOption.text = item.toString();
                    newOption.value = item.toString();
                    filt.add(newOption);
                })

            }


            // var $selectize_county = $(function () {
            //     $("#selectize_county").selectize({
            //         plugins: ["restore_on_backspace", "clear_button"],
            //         delimiter: " - ",
            //         persist: false,
            //         maxItems: null,
            //         valueField: "value",
            //         labelField: "label",
            //         searchField: ["value", "label"],
            //         options: pop_selectize_box(submission_data, "selectize_county", "county_single"),
            //         onChange: function (value, isOnInitialize) {
            //             updateChart(false)
            //         }
            //     });
            // });
            // var county_control = $selectize_county[0].selectize;
            // var $selectize_species = $(function () {
            //     $("#select_species").selectize({
            //         plugins: ["restore_on_backspace", "clear_button"],
            //         delimiter: " - ",
            //         persist: false,
            //         maxItems: null,
            //         valueField: "value",
            //         labelField: "label",
            //         searchField: ["value", "label"],
            //         options: pop_selectize_box(submission_data, "select_species", "cc_species"),
            //         onChange: function (value, isOnInitialize) {
            //             updateChart(false)
            //         }
            //     });
            // });
            // var species_control = $selectize_county[0].selectize;
            //pop_selectize_box(submission_data, "selectize_county", "county_single", control);

            pop_select_box(submission_data, "select_species", "cc_species");
            pop_select_box(submission_data, "select_soil_texture", "dominant_soil_texture");
            pop_select_box(submission_data, "select_seeding_method", "cc_seeding_method")
            pop_select_box(submission_data, "select_planting_year", "year");
            pop_select_box(submission_data, "select_county", "county_single");
            pop_select_box(submission_data, "select_tillage", "residue_remaining");
            // $('#select_species').selectize();


            // Add X axis
            var xScaleLinear = d3.scaleLinear()
                .domain([0, 7000])
                .range([0, width]);

            var xScaleTime = d3.scaleTime()
                .domain([new Date(2020, 2, 1), new Date(2020, 12, 1)])
                .range([0, width]);


            var xAxis = d3.axisBottom(xScaleTime);
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis)
                .attr("class", "myXAxis");

            // Add Y axis
            var yScale = d3.scaleLinear()
                .domain([0, 3.5])
                .range([height, 0]);

            var yAxis = d3.axisLeft(yScale);
            yAxis.ticks(10, ".1f")



            svg.append("g")
                .call(yAxis)
                .attr("class", "myYAxis")

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Cover crop biomass (ton/acre)");

            svg.append("text")      // text label for the x axis
                .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.bottom - 5) + ")")
                .style("text-anchor", "middle")
                .attr("class", "x_axis_label")
                .text("");


            // Add dots
            function enterPoints(data, property_and_scale) {
                var property = property_and_scale[0]
                var scale = property_and_scale[1]
                var color_property = property_and_scale[2]
                var color_scale = property_and_scale[3]

                svg.append('g')
                    .selectAll("dot")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx", function (d) { return scale(d.properties[property]); })
                    .attr("cy", function (d) { return yScale(d.properties.cc_biomass); })
                    .attr("r", 3)
                    .style("fill", function (d) { return color_scale((d.properties[color_property])); })
                    .style("stroke", "#252525")
                    .on("mouseover", function (d) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9)
                            .attr("r", 5);
                        div
                            .html(formatToolTip(d))
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function (d) {
                        div.transition()
                            .duration(500)
                            .attr("r", 3)
                            .style("opacity", 0);
                    });

                // For regression line
                svg.selectAll(".line").remove();
                $('#regression_equation').hide()
                $('#regression_explanation').hide()
                if (document.getElementById('checkbox_linreg_line').checked) {
                    $('#regression_equation').show();
                    $('#regression_explanation').show();

                    svg.append("path")
                        .datum(data)
                        .attr("class", "line")
                        .attr("fill", "none")
                        .attr("stroke", "steelblue")
                        .attr("stroke-width", 1.5)
                        .attr("d", d3.line()
                            .x(function (d) { return scale(d.properties[property]); })
                            .y(function (d) { return yScale(d.properties.predicted); })
                        )
                }
            }

            function updatePoints(data, property_and_scale) {
                var property = property_and_scale[0]
                var scale = property_and_scale[1]
                var color_property = property_and_scale[2]
                var color_scale = property_and_scale[3]
                svg.selectAll("circle")
                    .data(data)
                    .transition().duration(1000)
                    .attr("cx", function (d) { return scale(d.properties[property]); })
                    .attr("cy", function (d) { return yScale(d.properties.cc_biomass); })
                    .style("fill", function (d) { return color_scale((d.properties[color_property])); })


                svg.select(".myXAxis")
                    .transition()
                    .call(d3.axisBottom(scale))
                    // .ticks(d3.timeFormat("%Y"))
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-25)");


                var pretty_property;
                if (property == "acc_gdd") {
                    pretty_property = "Growing degree units"
                } else if (property == "total_precip") {
                    pretty_property = "Total precipitation (in)"
                } else if (property == "cc_planting_date_flat") {
                    pretty_property = "Cover crop planting date"
                }
                svg.select('.x_axis_label')
                    .transition().duration(1000)
                    .text(pretty_property);

                updateLegendGraph(color_scale)

            }

            function exitPoints(data) {
                svg.selectAll("circle")
                    .data(data)
                    .exit()
                    .remove();

            }

            function calcJulianDay(target_date) {

                var start = new Date(target_date.getFullYear(), 0, 0);
                var diff = target_date - start;
                var oneDay = 1000 * 60 * 60 * 24;
                var day = Math.floor(diff / oneDay);

                return day
            }

            function getDataForModel(data, xproperty) {


                let mod_data = [];
                for (let i = 0; i < data.length; i++) {

                    var y = data[i].properties.cc_biomass;
                    if (y === null) { continue }

                    var x = data[i].properties[xproperty];
                    if (x === null) { continue }

                    mod_data.push([x, y])

                }

                var n_removed = 99 - mod_data.length
                console.log(n_removed, " values were removed")
                console.log(mod_data)
                for (let i = 0; i < mod_data.length; i++) {
                    if (mod_data[i][0] == undefined) {

                    }
                }
                return mod_data;
            }

            function fitModel(mod_data, type = "linear") {

                if (type == "linear") {

                    var rslt = regression.linear(
                        // Using precision to 5 because fit is usually so bad as to be nearly zero
                        mod_data, { 'precision': 5 }
                    )

                    return rslt
                } else if (type == "quadratic") {
                    var rslt = regression.polynomial(
                        // Using precision to 5 because fit is usually so bad as to be nearly zero
                        mod_data, {
                        precision: 5,
                        order: 2
                    }
                    )

                    return rslt
                }

            }

            function prettyRegExplanation(xproperty, r2) {
                var pretty_prop;
                if (xproperty == "julian_day") {
                    pretty_prop = "Planting date"
                } else if (xproperty == "total_precip") {
                    pretty_prop = "Total precipitation (inches)"
                } else if (xproperty == "acc_gdd") {
                    pretty_prop = "Accumulated growing degree units"
                }

                pretty_prop += " explains " + roundUp(r2 * 100, 1) + " percent of the variation in cover crop biomass."

                return pretty_prop

            }

            function addRegressionLine(data) {
                var reg_expl = "explains"
                var xproperty = getScaleAndProperty(data)[0];
                if (xproperty == "cc_planting_date_flat") {
                    xproperty = "julian_day"
                }
                var model_type = d3.select("#select_model_type").node().value

                var data_for_model = getDataForModel(data, xproperty)

                var model_result = fitModel(data_for_model, model_type)
                console.log(model_result.string)
                console.log("R2: " + model_result.r2)


                $('#regression_equation').text(model_result.string)
                $('#regression_explanation').text(prettyRegExplanation(xproperty, model_result.r2))
                // model_data = []
                for (let i = 0; i < data.length; i++) {

                    data[i].properties.predicted = model_result.predict(data[i].properties[xproperty])[1]

                }

                // Sorting the data for tidy plotting
                data.sort(function (a, b) {
                    return a.properties[xproperty] - b.properties[xproperty];
                });

                return data

            }

            function getFilteredData(data) {

                var filtered_data = filterDataYear(data)

                filtered_data = filterDataSpecies(filtered_data)

                filtered_data = filterDataCounty(filtered_data)
                // filtered_data = filterDataCountySelectize(filtered_data)

                filtered_data = filterDataSoilText(filtered_data)

                filtered_data = filterDataSeedingMethod(filtered_data)

                filtered_data = filterDataTillage(filtered_data)

                filtered_data = filterDataManurePrior(filtered_data)

                filtered_data = filterDataManurePost(filtered_data)

                filtered_data = filterDataNulls(filtered_data)

                filtered_data = addRegressionLine(filtered_data)

                return filtered_data;

            }

            function filterDataSoilText(data, sdd) {

                var selector;
                selector = "#select_soil_texture";

                var soil_texture = d3.select(selector).node().value
                if (soil_texture == "All") {
                    return data
                }
                return data.filter(function (d) {
                    return d.properties.dominant_soil_texture == soil_texture;
                });

            }

            function filterDataSeedingMethod(data) {

                var selector;
                selector = "#select_seeding_method";

                var seeding_method = d3.select(selector).node().value
                if (seeding_method == "All") {
                    return data
                }
                return data.filter(function (d) {
                    return d.properties.cc_seeding_method == seeding_method;
                });
            }

            function filterDataManurePrior(data) {

                var selector;
                selector = "#checkbox_manure_prior"
                if (prior_manure) {
                    return data.filter(function (d) {
                        return d.properties.manure_prior == "Yes"
                    })
                } else {
                    return data
                }
            }

            function filterDataManurePost(data) {

                var selector;
                selector = "#checkbox_manure_post"
                if (post_manure) {
                    return data.filter(function (d) {
                        return d.properties.manure_post == "Yes"
                    })
                } else {
                    return data
                }
            }

            function filterDataYear(data, sdd) {
                // Reminder, won't be real year, 2020 == 120
                var selector;
                selector = "#select_planting_year";

                var year = d3.select(selector).node().value
                if (year == "All") {
                    return data
                }
                return data.filter(function (d) {
                    return d.properties.year == year;
                });

            }


            function filterDataSpecies(data, sdd) {
                // Reminder, won't be real year, 2020 == 120
                var selector;

                selector = "#select_species";

                var species = d3.select(selector).node().value
                console.log(species)
                if (species == "All") {
                    return data
                }
                return data.filter(function (d) {
                    return d.properties.cc_species === species;
                });

            }

            function filterDataCountySelectize(data, sdd) {

                var selector;

                selector = "#selectize_county";

                var county_array = $('#selectize_county').selectize()[0].selectize.getValue()


                if (county_array == null | county_array.length == 0) {
                    return data
                }
                return data.filter(function (d) {
                    var is_this_one = county_array.includes(d.properties.county_single)
                    console.log(d.id, is_this_one)
                    return county_array.includes(d.properties.county_single)
                    // return d.properties.county_single === county;
                });

            }

            function filterDataCounty(data, sdd) {

                var selector;

                selector = "#select_county";

                var county = d3.select(selector).node().value
                console.log(county + " County")
                if (county == "All") {
                    return data
                }
                return data.filter(function (d) {
                    return d.properties.county_single === county;
                });

            }

            function filterDataTillage(data, sdd) {
                // Reminder, won't be real year, 2020 == 120
                var selector;

                selector = "#select_tillage";

                var tillage_tier = d3.select(selector).node().value
                console.log(tillage_tier)
                if (tillage_tier == "All") {
                    return data
                }
                return data.filter(function (d) {
                    return d.properties.residue_remaining === tillage_tier;
                });

            }

            function filterDataNulls(data, sdd) {
                // Removing points with null biomass
                return data.filter(function (d) {
                    return d.properties.cc_biomass != null;
                });

            }

            enterPoints(data, getScaleAndProperty(data))
            updatePoints(data, getScaleAndProperty(data))

            function updateChart(sdd) {
                // https://stackoverflow.com/questions/39964570/how-to-filter-data-with-d3-js


                var filtered_data = getFilteredData(data);
                enterPoints(filtered_data, getScaleAndProperty(filtered_data));
                updatePoints(filtered_data, getScaleAndProperty(filtered_data));
                exitPoints(filtered_data, getScaleAndProperty(filtered_data));

                console.log("No. of data points: " + filtered_data.length)



            }


            d3.select("#xFactor").on("change", function () {
                console.log("Changed x to: " + this.value);

                updateChart(false);

            })


            d3.select("#select_color").on("change", function () {
                console.log("Changed color to: " + this.value);

                updateChart(false);

            })

            // Filter actions
            d3.select("#select_county").on("change", function () {
                console.log("Changed county to: " + this.value);

                updateChart(false);

            })

            d3.select("#select_species").on("change", function () {
                console.log("Changed species to: " + this.value);

                updateChart(false);

            })

            d3.select("#select_tillage").on("change", function () {
                console.log("Changed tillage to: " + this.value);

                updateChart(false);

            })

            d3.select("#select_planting_year").on("change", function () {

                console.log("Changed to: " + this.value)
                updateChart(false);

            })

            d3.select("#select_seeding_method").on("change", function () {

                console.log("Changed to: " + this.value)
                updateChart(false);

            })

            d3.select("#select_soil_texture").on("change", function () {

                console.log("Changed to: " + this.value)
                updateChart(false);

            })



            d3.select("#checkbox_linreg_line").on("change", function () {

                updateChart(false);

            })


            let prior_manure = document.getElementById('checkbox_manure_prior').checked;
            d3.select("#checkbox_manure_prior").on("change", function () {
                prior_manure = document.getElementById('checkbox_manure_prior').checked
                console.log("Changed prior manure: " + prior_manure)
                updateChart(false);

            })


            let post_manure = document.getElementById('checkbox_manure_post').checked;
            d3.select("#checkbox_manure_post").on("change", function () {

                post_manure = document.getElementById('checkbox_manure_post').checked

                console.log("Changed to post manure: " + post_manure)
                updateChart(false);

            })

            d3.select("#select_model_type").on("change", function () {

                console.log("Changed to: " + this.value)
                updateChart(false);

            })




            function getScaleAndProperty(filtered_data, sdd) {

                var property = d3.select("#xFactor").node().value
                var color_property = d3.select("#select_color").node().value


                var color_scale;
                if (color_property == "region") {
                    color_scale = colorScaleCounty;
                } else if (color_property == "cc_species") {
                    color_scale = speciesScale;
                } else if (color_property == "previous_crop") {
                    color_scale = colorScalePriorCrops
                }

                var scale;
                if (property == "acc_gdd") {

                    scale = xScaleLinear

                    scale.domain([0,
                        d3.max(filtered_data.map(function (child) {
                            return child.properties[property]
                        })
                        )
                    ]
                    );
                } else if (property == "total_precip") {

                    scale = xScaleLinear


                    scale.domain([0,
                        d3.max(filtered_data.map(function (child) {
                            return child.properties[property]
                        })
                        )
                    ]
                    );
                } else if ((property == "cc_planting_date") || (property == "cc_planting_date_flat")) {

                    scale = xScaleTime


                    scale.domain(
                        d3.extent(filtered_data.map(function (child) {
                            return child.properties[property]
                        })
                        )
                    );
                }

                return [property, scale, color_property, color_scale]
            }

            // Legend
            function updateLegendGraph(scale) {
                // d3.select(legendClassName).remove();
                var svg_legend = d3.select("#legend svg")

                svg_legend.append("g")
                    .attr("class", "legendSoil")
                    .attr("transform", "translate(-5,10)")
                // .style("height", 400);

                var legendSoil = d3.legendColor()
                    .scale(scale)
                // .orient("horizontal");

                svg_legend.select(".legendSoil")
                    .call(legendSoil);
            }

            $(document).ready(function () {
                updateChart(false)
            });

        })





    </script>
    <script>

        // add bootstrap table styles to pandoc tables
        function bootstrapStylePandocTables() {
            $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
        }
        $(document).ready(function () {
            bootstrapStylePandocTables();
        });


    </script>

    <!-- tabsets -->

    <script>


        $(document).ready(function () {
            $('.tabset-dropdown > .nav-tabs > li').click(function () {
                $(this).parent().toggleClass('nav-tabs-open')
            });
        });
    </script>

    <!-- code folding -->


    <!-- dynamically load mathjax for compatibility with self-contained -->
    <script>
        (function () {
            var script = document.createElement("script");
            script.type = "text/javascript";
            script.src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
            document.getElementsByTagName("head")[0].appendChild(script);
        })();
    </script>

</body>

</html>