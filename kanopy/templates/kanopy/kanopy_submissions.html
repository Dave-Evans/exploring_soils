{% extends 'kanopy/base_kanopy.html' %}

{% block title %}Welcome to Green CovR{% endblock %}

{% load static %}
{% load render_table from django_tables2 %}
{% load bootstrap4 %}

{% block content %}

 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
   <style>
    card-img {
      width: 50%;
      height: auto;
    }
  </style>
  <div style="display:none;" id="div-nodisplay">
  </div>
  <div class="row justify-content-center">
    <div class="col-lg-8 col-md-10 col-sm-12">
      <div class="card">
        <div class="card-body" id='master-card-body' >
          <input type="text" id="start_date" >
          <input type="text" id="end_date" >
          <br/>          
          <input id="filter" type="button" value="Filter"></input>
          

          <h3 class="card-title">Submissions</h3>
          
        </div>
        <div class="card-footer text-muted text-center">
          Questions? See our references <a href="#">page</a>
        </div>
      </div>
    </div>
  </div>
  
<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>  
<script>
    
    var end_upload_date = new Date( Date.now() );
    // var start_upload_date = new Date( Date.now() );
    // start_upload_date.setMonth( start_upload_date.getMonth() - 2 );
    var start_upload_date = new Date('2020-12-01')

    $("#start_date").val( start_upload_date);
    $("#end_date").val( end_upload_date);

    // Change to date selector
    $(document).ready(function () {
      $("#start_date").change(function() {
        start_upload_date = new Date( $("#start_date").val() );
      });
      $("#end_date").change(function() {
        console.log("Before: " + end_upload_date)
        end_upload_date = new Date( $("#end_date").val() );
        console.log("After: " + end_upload_date)
      });


      $("#filter").click(function () {
          
          filterCards()

      });       
    });

    function filterCards() {
      for (i=0; i<sjdocs.length; i++){
        var id = sjdocs[i].id;
        var uploaded_at = new Date(sjdocs[i].uploaded_at);
        var planting_date = new Date(sjdocs[i].cover_crop_planting_date);

        // If uploaded between start and end then show
        if (uploaded_at >= start_upload_date && uploaded_at <= end_upload_date){
          $("#sub-" + sjdocs[i].id).show();
        } else {
          $("#sub-" + sjdocs[i].id).hide();
        }
      };
    };    
    var subfreq = JSON.parse('{{ freq|escapejs }}');
    var sjdocs = JSON.parse('{{ sjdocs|escapejs }}');
    var sub_holder = $("<div/>");
    sub_holder.addClass("col-md-10");
    sub_holder.attr("id", "sub-holder");
    
    function draw() {
        // To hold the reference to individual images
        const images = {};

        for (i=0; i<sjdocs.length; i++){

          const subm_obj = {};
          subm_obj['id'] = sjdocs[i].id;
          // var sub_id = sjdocs[i].id;
          console.log("ID: " + subm_obj['id']);

          if(subm_obj['id'] < 20){
            console.log("Found it.");
            subm_obj['src_url'] = sjdocs[i].image;
            subm_obj['dst_cnvs'] = document.getElementById('dst-cnvs-' + subm_obj['id']);
            subm_obj['ctx'] = subm_obj['dst_cnvs'].getContext('2d');
            // var src_url = sjdocs[i].image;
            // var dst_cnvs = document.getElementById('dst-cnvs-' + sub_id);
            // var ctx = dst_cnvs.getContext('2d');

            // const img = images[sjdocs[i].location_name] = new Image;
            const img = subm_obj['image'] = new Image;
            
            // var img = new Image();
            img.onload = function() {
              subm_obj['ctx'].drawImage(img, 64, 64, 192, 192);
            };          
            img.src = subm_obj['src_url'];
            images['location_name'] = subm_obj;
          };

        };
        return images;
      };

    function showSubmissions() {
      //Remember to wipe away first

      for (i=0; i<sjdocs.length; i++) {
      

        var update_url = "groundcover_update/" + sjdocs[i].id;
        var uploaded_at = new Date(sjdocs[i].uploaded_at);
        // Look into using thumbnails
        // https://umbracofreelancer.uk/blog/post/create-thumbnails-using-javascript/
        var image_url = sjdocs[i].image;
        var id = sjdocs[i].id;
        // var image_url = "{% static 'img/cover_crop_good_image.jpg' %}";
        var location_name = sjdocs[i].location_name;
        var comment = sjdocs[i].comment;
        var cover_crop_species_1= sjdocs[i].cover_crop_species_1;
        var photo_taken_date = new Date(sjdocs[i].photo_taken_date);
        
        // console.log(sjdocs[i].location_name);<canvas class="card-img" id="myCanvas" ></canvas>
        sub_holder.append(
          '<div id="sub-' + id + '" class="card" style="width: 600px;"><div class="row no-gutters">  <div class="col-sm-5">  <canvas class="card-img" id="dst-cnvs-' + 
            id + '" ></canvas>  </div>  <div class="col-sm-7"><div class="card-body"><h5 class="card-title">' + 
              location_name + '</h5> <h6 class="card-subtitle mb-2 text-muted">Uploaded on ' + 
                uploaded_at.toLocaleDateString() + ', photo taken on ' + 
                  photo_taken_date.toLocaleDateString() + '</h6> <p class="card-text">' + 
                    cover_crop_species_1 + '</p> <a href="' + 
                    update_url + '" class="btn btn-primary">Open</a> </div>  </div></div></div>'
        ); 
      };
      
      $("#master-card-body").append(sub_holder);
    };
    showSubmissions();
    draw();
    filterCards();  

</script> 


    

{% endblock %}
