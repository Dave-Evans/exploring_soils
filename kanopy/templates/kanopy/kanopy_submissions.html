{% extends 'kanopy/base_kanopy.html' %}

{% block title %}Welcome to Green CovR{% endblock %}

{% load static %}
{% load render_table from django_tables2 %}
{% load bootstrap4 %}

{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin="" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
  crossorigin=""></script>
<style>
  card-img {
    width: 50%;
    height: auto;
  }
</style>
<div style="display:none;" id="div-nodisplay">
</div>
<div class="row justify-content-center">
  <div class="col-lg-8 col-md-10 col-sm-12">
    <div class="card">
      <div class="card-body" id='master-card-body'>
        <h3 class="card-title">Review submissions by uploaded time</h3>

        <input type="text" id="start_date"></input>
        <input type="text" id="end_date"></input>
        <br />
        <input id="filter" type="button" value="Filter"></input>




      </div>
      <div class="card-footer text-muted text-center">
        Questions? See our references <a href="#">page</a>
      </div>
    </div>
  </div>
</div>

<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
<script type="text/javascript" src="https://d3js.org/d3.v6.min.js"></script>
<script>
  var data = JSON.parse('{{ freq|escapejs }}');

  var margin = { top: 20, right: 20, bottom: 70, left: 40 },
    width = 500 - margin.left - margin.right,
    height = 200 - margin.top - margin.bottom;

  // Parse the date / time
  var parseDate = d3.timeParse("%Y-%m-%d");
  var formatDate = d3.timeFormat("%B %d, %Y");

  var x = d3.scaleBand().range([0, width], .05);

  var y = d3.scaleLinear().range([height, 0]);

  var yAxis = d3.axisLeft()
    .scale(y)
    .ticks(3);

  var svg = d3.select("#master-card-body").insert("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
      "translate(" + margin.left + "," + margin.top + ")");
  var eventData;
  var mouseEvent;
  // d3.csv("total_mileage.csv").then(function(data) {
  data.forEach(function (d) {
    d.date = parseDate(d.dt_seq);
    d.value = +d.num_uploads;
  });

  x.domain(data.map(function (d) { return d.date; }));
  y.domain([0, d3.max(data, function (d) { return d.value; })]);

  // custom invert function
  x.invert = (function () {
    var domain = x.domain()
    var range = x.range()
    var scale = d3.scaleQuantize().domain(range).range(domain)

    return function (x) {
      return scale(x)
    }
  })()

  // Add the brush feature using the d3.brush function
  var brush = d3.brushX()
    // initialise the brush area: start at 0,0 and finishes at width,height: it means I select the whole graph area
    .extent([[0, 0], [width, height]])
    // Each time the brush selection changes, trigger the 'updateDates' function
    .on("end", updateDates);

  // Defining xAxis here so that we can
  //  set tick values...before scales?
  var xAxis = d3.axisBottom()
    .tickFormat(d3.timeFormat('%b %d'))
    //.ticks(d3.timeDay.every(100))
    .tickValues(x.domain().filter(function (d, i) { return !(i % 100) }))
    .scale(x);

  svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis)
    .selectAll("text")
    .style("text-anchor", "end")
    .attr("dx", "-.8em")
    .attr("dy", ".15em")
    .attr("transform", "rotate(-15)");

  svg.append("g")
    .attr("class", "y axis")
    .call(yAxis)
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", 6)
    .attr("dy", ".71em")
    .style("text-anchor", "end");

  svg.append("g")
    .selectAll("bar")
    .data(data)
    .enter().append("rect")
    .attr("class", "bar")
    .on("mouseover", onMouseOver) //Add listener for the mouseover event
    .on("mouseout", onMouseOut)   //Add listener for the mouseout event      
    .attr("x", function (d) { return x(d.date); })
    .attr("width", x.bandwidth())
    .attr("y", function (d) { return y(d.value); })
    .attr("height", function (d) { return height - y(d.value); });

  // Add the brushing
  var dummyend = data[data.length - 1]['date'];
  var dummystrt = data[data.length - 10]['date'];

  svg.append("g")
    .attr("class", "brush")
    .call(brush)
    .call(brush.move, [x(dummystrt), x(dummyend)]);

  //mouseover event handler function
  // Updating for v6
  //function onMouseOver(d, i) {
  function onMouseOver(event, d) {
    eventData = event;
    mouseEvent = d;

    d3.select(this).attr('class', 'highlight');
    svg.append("text")
      .attr('class', 'val')
      .attr('x', function () {
        return x(d.date);
      })
      .attr('y', function () {
        return y(d.value) - 15;
      })
      .text(function () {
        return [formatDate(d.date) + ": " + d.value + " uploads"];  // Value of the text
      });
  }

  //mouseout event handler function
  //mouseover event handler function
  // Updating for v6
  //function onMouseOut(d, i) {
  function onMouseOut(event, d) {
    // use the text label class to remove label on mouseout
    d3.select(this).attr('class', 'bar');
    d3.select(this)
      .transition()     // adds animation
      .duration(400)
      .attr('width', x.bandwidth())
      .attr("y", function (d) { return y(d.value); })
      .attr("height", function (d) { return height - y(d.value); });

    d3.selectAll('.val')
      .remove()
  }

  function updateDates({ selection: extent }) {

    console.log(extent);
    if (extent === null) {
      return;
    }
    var selected_start = x.invert(extent[0]);
    var selected_end = x.invert(extent[1]);
    console.log("Start: ", selected_start);
    console.log("End: ", selected_end);

    // For debugging
    $("#start_date").val(selected_start);
    $("#end_date").val(selected_end);

    start_upload_date = selected_start;
    end_upload_date = selected_end;
    if (typeof filterCards != "undefined") {
      filterCards(start_upload_date, end_upload_date);
    }
  }

  // Graph title
  d3.select('svg')
    .append("text")
    .attr("x", 10)
    .attr("y", margin.top + -5)
    .attr("font-size", 12)
    .attr("text-anchor", "left")
    .text("Select by submission date");

</script>
<script>


  var end_upload_date = new Date(Date.now());
  var start_upload_date = new Date(Date.now());
  start_upload_date.setMonth(start_upload_date.getMonth() - 2);

  $("#start_date").val(start_upload_date);
  $("#end_date").val(end_upload_date);

  // Change to date selector
  $(document).ready(function () {
    $("#start_date").change(function () {
      start_upload_date = new Date($("#start_date").val());
    });
    $("#end_date").change(function () {
      end_upload_date = new Date($("#end_date").val());
    });


    $("#filter").click(function () {

      filterCards(start_upload_date, end_upload_date);

    });
  });

  function filterCards(dt_start, dt_end) {
    console.log("Running filterCards");
    console.log("dt_start: " + dt_start);
    console.log("dt_end: " + dt_end);
    var count_of_returned_docs = 0;
    for (i = 0; i < sjdocs.length; i++) {
      var id = sjdocs[i].id;
      var uploaded_at = new Date(sjdocs[i].uploaded_at);
      var planting_date = new Date(sjdocs[i].cover_crop_planting_date);

      // If uploaded between start and end then show
      if (uploaded_at >= dt_start && uploaded_at <= dt_end) {
        // console.log("Show sub-" + sjdocs[i].id);
        $("#sub-" + sjdocs[i].id).show();
        count_of_returned_docs += 1;
      } else {
        // console.log("Hide sub-" + sjdocs[i].id);
        $("#sub-" + sjdocs[i].id).hide();

      }
    };
    if (count_of_returned_docs == 0) {

    }
  };

  var sjdocs = JSON.parse('{{ sjdocs|escapejs }}');
  var sub_holder = $("<div/>");
  sub_holder.addClass("col-md-10");
  sub_holder.attr("id", "sub-holder");

  function draw() {
    // To hold the reference to individual images
    const images = {};

    for (i = 0; i < sjdocs.length; i++) {

      const subm_obj = {};
      subm_obj['id'] = sjdocs[i].id;
      // var sub_id = sjdocs[i].id;
      // console.log("ID: " + subm_obj['id']);

      if (subm_obj['id'] < 20) {
        console.log("Found it.");
        subm_obj['src_url'] = sjdocs[i].image;
        subm_obj['dst_cnvs'] = document.getElementById('dst-cnvs-' + subm_obj['id']);
        subm_obj['ctx'] = subm_obj['dst_cnvs'].getContext('2d');
        // var src_url = sjdocs[i].image;
        // var dst_cnvs = document.getElementById('dst-cnvs-' + sub_id);
        // var ctx = dst_cnvs.getContext('2d');

        // const img = images[sjdocs[i].location_name] = new Image;
        const img = subm_obj['image'] = new Image;

        // var img = new Image();
        img.onload = function () {
          subm_obj['ctx'].drawImage(img, 64, 64, 192, 192);
        };
        img.src = subm_obj['src_url'];
        images['location_name'] = subm_obj;
      };

    };
    return images;
  };

  function showSubmissions() {
    //Remember to wipe away first

    for (i = 0; i < sjdocs.length; i++) {


      var update_url = "/groundcover_update/" + sjdocs[i].id;
      var uploaded_at = new Date(sjdocs[i].uploaded_at);
      // Look into using thumbnails
      // https://umbracofreelancer.uk/blog/post/create-thumbnails-using-javascript/
      var image_url = sjdocs[i].image;
      var id = sjdocs[i].id;
      // var image_url = "{% static 'img/cover_crop_good_image.jpg' %}";
      var location_name = sjdocs[i].location_name;
      var comment = sjdocs[i].comment;
      var cover_crop_species_1 = sjdocs[i].cover_crop_species_1;
      var photo_taken_date = new Date(sjdocs[i].photo_taken_date);

      // console.log(sjdocs[i].location_name);<canvas class="card-img" id="myCanvas" ></canvas>
      sub_holder.append(
        '<div id="sub-' + id + '" class="card" style="width: 600px;"><div class="row no-gutters">  <div class="col-sm-5">  <canvas class="card-img" id="dst-cnvs-' +
        id + '" ></canvas>  </div>  <div class="col-sm-7"><div class="card-body"><h5 class="card-title">' +
        location_name + '</h5> <h6 class="card-subtitle mb-2 text-muted">Uploaded on ' +
        uploaded_at.toLocaleDateString() + ', photo taken on ' +
        photo_taken_date.toLocaleDateString() + '</h6> <p class="card-text">' +
        cover_crop_species_1 + '</p> <a href="' +
        update_url + '" class="btn btn-primary">Open</a> </div>  </div></div></div>'
      );
    };

    $("#master-card-body").append(sub_holder);
  };
  showSubmissions();
  draw();
  filterCards(start_upload_date, end_upload_date);

</script>





{% endblock %}